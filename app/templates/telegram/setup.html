{% extends "base.html" %}

{% block title %}Telegram Webhook Setup - {{ bot.name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="mb-4">
            <h2>üîó Telegram Webhook Setup</h2>
            <p class="text-muted">Configure Telegram webhook for bot: <strong>{{ bot.name }}</strong></p>
            <a href="{{ url_for('bot.list_bots') }}" class="btn btn-sm btn-outline-secondary">‚Üê Back to Bots</a>
        </div>

        {% if not bot.telegram_token %}
        <div class="alert alert-warning">
            <h5>‚ö†Ô∏è No Telegram Token</h5>
            <p class="mb-0">This bot does not have a Telegram token configured. Please edit the bot and add a token from @BotFather.</p>
        </div>
        {% else %}

        <!-- Bot Info -->
        {% if bot_info %}
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">Bot Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-2"><strong>Bot Username:</strong> @{{ bot_info.username }}</p>
                        <p class="mb-2"><strong>Bot ID:</strong> {{ bot_info.id }}</p>
                        <p class="mb-0"><strong>Name:</strong> {{ bot_info.first_name }}</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-2"><strong>Can Join Groups:</strong> {{ '‚úÖ Yes' if bot_info.can_join_groups else '‚ùå No' }}</p>
                        <p class="mb-2"><strong>Can Read All Messages:</strong> {{ '‚úÖ Yes' if bot_info.can_read_all_group_messages else '‚ùå No' }}</p>
                        <p class="mb-0"><strong>Supports Inline:</strong> {{ '‚úÖ Yes' if bot_info.supports_inline_queries else '‚ùå No' }}</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Webhook Status -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Webhook Status</h5>
            </div>
            <div class="card-body">
                {% if webhook_info and webhook_info.url %}
                    <div class="alert alert-success mb-3">
                        <h6>‚úÖ Webhook Active</h6>
                        <p class="mb-1"><strong>URL:</strong> <code>{{ webhook_info.url }}</code></p>
                        <p class="mb-1"><strong>Pending Updates:</strong> {{ webhook_info.pending_update_count }}</p>
                        {% if webhook_info.last_error_message %}
                        <p class="mb-0 text-danger"><strong>Last Error:</strong> {{ webhook_info.last_error_message }}</p>
                        {% endif %}
                    </div>
                    
                    <form method="POST" onsubmit="return confirm('Are you sure you want to delete the webhook?');">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="action" value="delete_webhook">
                        <button type="submit" class="btn btn-danger">Delete Webhook</button>
                    </form>
                {% else %}
                    <div class="alert alert-warning mb-3">
                        <h6>‚ö†Ô∏è No Webhook Configured</h6>
                        <p class="mb-0">Set up a webhook to start receiving messages from Telegram.</p>
                    </div>

                    <!-- Auto-detect current domain -->
                    <div class="alert alert-info mb-3">
                        <h6>üéØ Avtomatik Webhook URL</h6>
                        <p class="mb-2">Sizning saytingiz URL'i: <strong>{{ request.host_url }}</strong></p>
                        <p class="mb-0">To'liq webhook URL: <code>{{ request.host_url }}telegram/webhook/{{ bot.id }}</code></p>
                    </div>

                    <form method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="action" value="set_webhook">
                        
                        <div class="mb-3">
                            <label for="webhook_url" class="form-label">Webhook Base URL <span class="text-danger">*</span></label>
                            <input 
                                type="url" 
                                class="form-control" 
                                id="webhook_url" 
                                name="webhook_url" 
                                value="{{ request.host_url.rstrip('/') }}"
                                placeholder="https://yourdomain.com"
                                required>
                            <div class="form-text">
                                <strong>‚úÖ Avtomatik to'ldirildi!</strong> Agar kerak bo'lsa, o'zgartirishingiz mumkin.
                                <br>To'liq webhook URL: <code id="full-webhook-url">{{ request.host_url }}telegram/webhook/{{ bot.id }}</code>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg">
                                üöÄ Webhook O'rnatish
                            </button>
                        </div>
                    </form>

                    <script>
                        // Update full webhook URL when base URL changes
                        document.getElementById('webhook_url').addEventListener('input', function() {
                            const baseUrl = this.value.replace(/\/$/, '');
                            const fullUrl = baseUrl + '/telegram/webhook/{{ bot.id }}';
                            document.getElementById('full-webhook-url').textContent = fullUrl;
                        });
                    </script>
                {% endif %}
            </div>
        </div>

        <!-- Webhook Ma'lumotlari -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">üìö Webhook Haqida Ma'lumot</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>üéØ Sizning Webhook URL'ingiz:</h6>
                        <div class="bg-light p-3 rounded mb-3">
                            <code>{{ request.host_url }}telegram/webhook/{{ bot.id }}</code>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>ü§ñ Bot Username:</h6>
                        <div class="bg-light p-3 rounded mb-3">
                            <code>@{{ bot_info.username if bot_info else 'sizning_botingiz' }}</code>
                        </div>
                    </div>
                </div>

                <h6>‚öôÔ∏è Qanday ishlaydi:</h6>
                <div class="row">
                    <div class="col-md-3 text-center mb-3">
                        <div class="bg-primary text-white p-3 rounded">
                            <h5>1Ô∏è‚É£</h5>
                            <small>Foydalanuvchi botga xabar yozadi</small>
                        </div>
                    </div>
                    <div class="col-md-3 text-center mb-3">
                        <div class="bg-info text-white p-3 rounded">
                            <h5>2Ô∏è‚É£</h5>
                            <small>Telegram webhook'ga yuboradi</small>
                        </div>
                    </div>
                    <div class="col-md-3 text-center mb-3">
                        <div class="bg-warning text-dark p-3 rounded">
                            <h5>3Ô∏è‚É£</h5>
                            <small>AI javob tayyorlaydi</small>
                        </div>
                    </div>
                    <div class="col-md-3 text-center mb-3">
                        <div class="bg-success text-white p-3 rounded">
                            <h5>4Ô∏è‚É£</h5>
                            <small>Foydalanuvchiga javob yuboriladi</small>
                        </div>
                    </div>
                </div>

                <div class="alert alert-success mt-4">
                    <h6>‚úÖ Hamma narsa tayyor!</h6>
                    <p class="mb-0">
                        Sizning saytingiz <strong>{{ request.host_url }}</strong> allaqachon HTTPS va internet orqali ochiq. 
                        Faqat yuqoridagi "üöÄ Webhook O'rnatish" tugmasini bosing!
                    </p>
                </div>
            </div>
        </div>

        <!-- Test Bot -->
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">üß™ Test Bot</h5>
            </div>
            <div class="card-body">
                <p>Test your bot integration without setting up a webhook</p>
                <a href="{{ url_for('telegram.test_bot', bot_id=bot.id) }}" class="btn btn-success">
                    Go to Test Page
                </a>
            </div>
        </div>

        {% endif %}
    </div>
</div>
{% endblock %}
