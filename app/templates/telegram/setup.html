{% extends "base.html" %}

{% block title %}Telegram Webhook Setup - {{ bot.name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="mb-4">
            <h2>üîó Telegram Webhook Setup</h2>
            <p class="text-muted">Configure Telegram webhook for bot: <strong>{{ bot.name }}</strong></p>
            <a href="{{ url_for('bot.list_bots') }}" class="btn btn-sm btn-outline-secondary">‚Üê Back to Bots</a>
        </div>

        {% if not bot.telegram_token %}
        <div class="alert alert-warning">
            <h5>‚ö†Ô∏è No Telegram Token</h5>
            <p class="mb-0">This bot does not have a Telegram token configured. Please edit the bot and add a token from @BotFather.</p>
        </div>
        {% else %}

        <!-- Bot Info -->
        {% if bot_info %}
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">Bot Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-2"><strong>Bot Username:</strong> @{{ bot_info.username }}</p>
                        <p class="mb-2"><strong>Bot ID:</strong> {{ bot_info.id }}</p>
                        <p class="mb-0"><strong>Name:</strong> {{ bot_info.first_name }}</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-2"><strong>Can Join Groups:</strong> {{ '‚úÖ Yes' if bot_info.can_join_groups else '‚ùå No' }}</p>
                        <p class="mb-2"><strong>Can Read All Messages:</strong> {{ '‚úÖ Yes' if bot_info.can_read_all_group_messages else '‚ùå No' }}</p>
                        <p class="mb-0"><strong>Supports Inline:</strong> {{ '‚úÖ Yes' if bot_info.supports_inline_queries else '‚ùå No' }}</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Webhook Status -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Webhook Status</h5>
            </div>
            <div class="card-body">
                {% if webhook_info and webhook_info.url %}
                    <div class="alert alert-success mb-3">
                        <h6>‚úÖ Webhook Active</h6>
                        <p class="mb-1"><strong>URL:</strong> <code>{{ webhook_info.url }}</code></p>
                        <p class="mb-1"><strong>Pending Updates:</strong> {{ webhook_info.pending_update_count }}</p>
                        {% if webhook_info.last_error_message %}
                        <p class="mb-0 text-danger"><strong>Last Error:</strong> {{ webhook_info.last_error_message }}</p>
                        {% endif %}
                    </div>
                    
                    <form method="POST" onsubmit="return confirm('Are you sure you want to delete the webhook?');">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="action" value="delete_webhook">
                        <button type="submit" class="btn btn-danger">Delete Webhook</button>
                    </form>
                {% else %}
                    <div class="alert alert-warning mb-3">
                        <h6>‚ö†Ô∏è No Webhook Configured</h6>
                        <p class="mb-0">Set up a webhook to start receiving messages from Telegram.</p>
                    </div>

                    <form method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="action" value="set_webhook">
                        
                        <div class="mb-3">
                            <label for="webhook_url" class="form-label">Webhook Base URL <span class="text-danger">*</span></label>
                            <input 
                                type="url" 
                                class="form-control" 
                                id="webhook_url" 
                                name="webhook_url" 
                                placeholder="https://yourdomain.com"
                                required>
                            <div class="form-text">
                                Your public domain (must be HTTPS). The full webhook URL will be: 
                                <code>https://yourdomain.com/telegram/webhook/{{ bot.id }}</code>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-success">Set Webhook</button>
                    </form>
                {% endif %}
            </div>
        </div>

        <!-- Webhook Information -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">‚ÑπÔ∏è Webhook Information</h5>
            </div>
            <div class="card-body">
                <h6>Your Webhook Endpoint:</h6>
                <div class="bg-light p-3 rounded mb-3">
                    <code>POST /telegram/webhook/{{ bot.id }}</code>
                </div>

                <h6>How It Works:</h6>
                <ol>
                    <li>User sends a message to your Telegram bot (@{{ bot_info.username if bot_info else 'your_bot' }})</li>
                    <li>Telegram sends the message to your webhook URL</li>
                    <li>BotFactory processes the message with AI (using bot's system prompt)</li>
                    <li>AI response is sent back to the user on Telegram</li>
                </ol>

                <h6 class="mt-3">Requirements:</h6>
                <ul>
                    <li>Your application must be publicly accessible (HTTPS required)</li>
                    <li>Use ngrok, localtunnel, or deploy to a server for testing</li>
                    <li>Bot must have a Telegram token configured</li>
                    <li>GOOGLE_API_KEY must be set for AI responses</li>
                </ul>

                <h6 class="mt-3">Testing Locally with ngrok:</h6>
                <div class="bg-dark text-light p-3 rounded">
                    <code>
                        # Install ngrok<br>
                        # Download from https://ngrok.com/<br><br>
                        
                        # Run ngrok<br>
                        ngrok http 5000<br><br>
                        
                        # Copy the HTTPS URL (e.g., https://abc123.ngrok.io)<br>
                        # Use it as your webhook base URL above
                    </code>
                </div>
            </div>
        </div>

        <!-- Test Bot -->
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">üß™ Test Bot</h5>
            </div>
            <div class="card-body">
                <p>Test your bot integration without setting up a webhook</p>
                <a href="{{ url_for('telegram.test_bot', bot_id=bot.id) }}" class="btn btn-success">
                    Go to Test Page
                </a>
            </div>
        </div>

        {% endif %}
    </div>
</div>
{% endblock %}
